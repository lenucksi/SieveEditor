#!/bin/bash
# Conventional Commits Validation Hook
# This hook validates commit messages against the Conventional Commits specification.
# Installation: git config core.hooksPath .githooks

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Color codes for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# Conventional Commits regex pattern
# Supports: type(scope): subject or type!: subject or type: subject
# Types: feat, fix, docs, test, chore, refactor, perf, security, deps, build, ci
PATTERN="^(feat|fix|docs|test|chore|refactor|perf|security|deps|build|ci)(\(.+\))?!?: .{1,80}"

# Allow merge commits, revert commits, and release commits
if echo "$COMMIT_MSG" | grep -qE "^(Merge|Revert|Release|Initial commit)"; then
    exit 0
fi

# Validate commit message
if ! echo "$COMMIT_MSG" | grep -qE "$PATTERN"; then
    echo -e "${RED}❌ Invalid commit message format!${NC}"
    echo ""
    echo -e "${YELLOW}Your commit message:${NC}"
    echo "$COMMIT_MSG"
    echo ""
    echo -e "${YELLOW}Expected format:${NC}"
    echo "  <type>(<scope>): <subject>"
    echo ""
    echo -e "${YELLOW}Valid types:${NC}"
    echo "  feat      - New feature (bumps minor version)"
    echo "  fix       - Bug fix (bumps patch version)"
    echo "  perf      - Performance improvement (bumps patch version)"
    echo "  security  - Security fix (bumps patch version)"
    echo "  deps      - Dependency update (bumps patch version)"
    echo "  docs      - Documentation only"
    echo "  test      - Adding tests"
    echo "  chore     - Maintenance tasks"
    echo "  refactor  - Code refactoring"
    echo "  build     - Build system changes"
    echo "  ci        - CI/CD configuration changes"
    echo ""
    echo -e "${YELLOW}Examples:${NC}"
    echo "  feat(profiles): add multi-profile support"
    echo "  fix(connection): prevent timeout on slow networks"
    echo "  docs: update installation instructions"
    echo "  feat!: enforce SSL certificate validation (breaking change)"
    echo ""
    echo -e "${YELLOW}More info:${NC} https://www.conventionalcommits.org/"
    echo ""
    exit 1
fi

# Validate subject line length (should be <= 80 chars for first line)
SUBJECT_LINE=$(echo "$COMMIT_MSG" | head -n 1)
SUBJECT_LENGTH=${#SUBJECT_LINE}

if [ $SUBJECT_LENGTH -gt 100 ]; then
    echo -e "${RED}⚠️  Warning: Subject line is too long (${SUBJECT_LENGTH} chars, recommended <= 80)${NC}"
    echo "  Consider shortening: $SUBJECT_LINE"
    echo ""
    # Don't fail, just warn
fi

# Success
echo -e "${GREEN}✓ Commit message follows Conventional Commits${NC}"
exit 0
