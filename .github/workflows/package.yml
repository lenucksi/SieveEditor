name: Package

on:
  workflow_call:  # Called by release.yml
    inputs:
      version:
        description: 'Version to package'
        required: true
        type: string
      tag_name:
        description: 'Release tag name'
        required: true
        type: string
    secrets:
      GITHUB_TOKEN:
        required: true
  workflow_dispatch:  # Manual trigger for testing
    inputs:
      version:
        description: 'Version to package (e.g., 0.0.1)'
        required: true
        default: '0.0.1'
  release:
    types: [published]  # Trigger when release is published

permissions:
  contents: read
  id-token: write  # For artifact attestations
  attestations: write  # For provenance

jobs:
  # Build JAR once, use for all platforms
  build-jar:
    name: Build JAR
    runs-on: ubuntu-latest

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Set up JDK 21
        uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165 # v5.0.0
        with:
          java-version: 21
          distribution: 'temurin'
          cache: 'maven'

      - name: Build JAR
        run: mvn clean package -DskipTests -B

      - name: Upload JAR for packaging
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: sieveeditor-jar
          path: target/SieveEditor-jar-with-dependencies.jar
          retention-days: 7

  # Linux packaging: DEB, RPM
  package-linux:
    name: Package Linux (${{ matrix.package-type }})
    runs-on: ubuntu-latest
    needs: build-jar
    strategy:
      matrix:
        package-type: [deb, rpm]

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Set up JDK 21
        uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165 # v5.0.0
        with:
          java-version: 21
          distribution: 'temurin'

      - name: Install packaging tools
        run: |
          if [ "${{ matrix.package-type }}" = "deb" ]; then
            sudo apt-get update
            sudo apt-get install -y fakeroot
          elif [ "${{ matrix.package-type }}" = "rpm" ]; then
            sudo apt-get update
            sudo apt-get install -y rpm
          fi

      - name: Download JAR
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          name: sieveeditor-jar
          path: target

      - name: Get version
        id: version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            # Called via workflow_call from release.yml
            VERSION="${{ inputs.version }}"
          elif [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"  # Remove 'v' prefix
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="0.0.1-SNAPSHOT"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Create package
        run: |
          jpackage \
            --input target \
            --main-jar SieveEditor-jar-with-dependencies.jar \
            --main-class de.febrildur.sieveeditor.Application \
            --name SieveEditor \
            --app-version ${{ steps.version.outputs.version }} \
            --vendor "SieveEditor Project" \
            --description "ManageSieve script editor for managing email filtering rules" \
            --copyright "Copyright 2025 SieveEditor Contributors" \
            --type ${{ matrix.package-type }} \
            --linux-shortcut \
            --linux-menu-group "Network;Email" \
            --linux-app-category "Network" \
            --java-options '-Dsun.java2d.uiScale=2.0'

      - name: Find package file
        id: package
        run: |
          if [ "${{ matrix.package-type }}" = "deb" ]; then
            PKG=$(ls sieveeditor_*.deb)
          elif [ "${{ matrix.package-type }}" = "rpm" ]; then
            PKG=$(ls sieveeditor-*.rpm)
          fi
          echo "file=$PKG" >> $GITHUB_OUTPUT
          echo "Package created: $PKG"
          ls -lh $PKG

      - name: Upload package artifact
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: sieveeditor-${{ matrix.package-type }}
          path: ${{ steps.package.outputs.file }}
          retention-days: 30

      - name: Attest package provenance
        uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a # v3.0.0
        with:
          subject-path: ${{ steps.package.outputs.file }}

  # Windows packaging: MSI
  package-windows:
    name: Package Windows (MSI)
    runs-on: windows-latest
    needs: build-jar

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Set up JDK 21
        uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165 # v5.0.0
        with:
          java-version: 21
          distribution: 'temurin'

      - name: Install WiX Toolset
        run: |
          choco install wixtoolset -y
          echo "C:\Program Files (x86)\WiX Toolset v3.11\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Download JAR
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          name: sieveeditor-jar
          path: target

      - name: Get version
        id: version
        shell: bash
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            # Called via workflow_call from release.yml
            VERSION="${{ inputs.version }}"
          elif [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="0.0.1"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Create MSI package
        shell: cmd
        run: |
          jpackage ^
            --input target ^
            --main-jar SieveEditor-jar-with-dependencies.jar ^
            --main-class de.febrildur.sieveeditor.Application ^
            --name SieveEditor ^
            --app-version ${{ steps.version.outputs.version }} ^
            --vendor "SieveEditor Project" ^
            --description "ManageSieve script editor" ^
            --copyright "Copyright 2025 SieveEditor Contributors" ^
            --type msi ^
            --win-dir-chooser ^
            --win-menu ^
            --win-shortcut ^
            --win-menu-group "SieveEditor" ^
            --java-options "-Dsun.java2d.uiScale=2.0"

      - name: Find MSI file
        id: package
        shell: bash
        run: |
          MSI=$(ls SieveEditor-*.msi)
          echo "file=$MSI" >> $GITHUB_OUTPUT
          echo "Package created: $MSI"
          ls -lh $MSI

      - name: Upload MSI artifact
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: sieveeditor-msi
          path: ${{ steps.package.outputs.file }}
          retention-days: 30

      - name: Attest package provenance
        uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a # v3.0.0
        with:
          subject-path: ${{ steps.package.outputs.file }}

  # macOS packaging: DMG
  package-macos:
    name: Package macOS (DMG)
    runs-on: macos-latest
    needs: build-jar

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Set up JDK 21
        uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165 # v5.0.0
        with:
          java-version: 21
          distribution: 'temurin'

      - name: Download JAR
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          name: sieveeditor-jar
          path: target

      - name: Get version
        id: version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            # Called via workflow_call from release.yml
            VERSION="${{ inputs.version }}"
          elif [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="0.0.1"
          fi

          # Strip any suffix like -SNAPSHOT for macOS compatibility
          # macOS versions must be numeric with periods only
          CLEAN_VERSION="${VERSION%%-*}"

          # Extract up to 3 numeric components for macOS compatibility
          # macOS jpackage requires versions in format: 1, 1.2, or 1.2.3
          if [[ "$CLEAN_VERSION" =~ ^([0-9]+)\.([0-9]+)\.([0-9]+) ]]; then
            # 3 components: x.y.z (take only first 3, ignore any 4th component)
            MAC_VERSION="${BASH_REMATCH[1]}.${BASH_REMATCH[2]}.${BASH_REMATCH[3]}"
          elif [[ "$CLEAN_VERSION" =~ ^([0-9]+)\.([0-9]+) ]]; then
            # 2 components: x.y
            MAC_VERSION="${BASH_REMATCH[1]}.${BASH_REMATCH[2]}"
          elif [[ "$CLEAN_VERSION" =~ ^([0-9]+)$ ]]; then
            # 1 component: x
            MAC_VERSION="${BASH_REMATCH[1]}"
          else
            # Invalid format, use default
            MAC_VERSION="1.0.0"
          fi

          # macOS prefers versions starting with 1 or higher
          # Transform versions starting with 0 to start with 1
          if [[ "$MAC_VERSION" =~ ^0\.([0-9]+)\.([0-9]+)$ ]]; then
            MAC_VERSION="1.${BASH_REMATCH[1]}.${BASH_REMATCH[2]}"
            echo "Transformed version $CLEAN_VERSION to $MAC_VERSION for macOS compatibility"
          elif [[ "$MAC_VERSION" =~ ^0\.([0-9]+)$ ]]; then
            MAC_VERSION="1.${BASH_REMATCH[1]}"
            echo "Transformed version $CLEAN_VERSION to $MAC_VERSION for macOS compatibility"
          elif [[ "$MAC_VERSION" = "0" ]]; then
            MAC_VERSION="1.0.0"
            echo "Transformed version $CLEAN_VERSION to $MAC_VERSION for macOS compatibility"
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "mac_version=$MAC_VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION (macOS: $MAC_VERSION)"

      - name: Create DMG package
        run: |
          jpackage \
            --input target \
            --main-jar SieveEditor-jar-with-dependencies.jar \
            --main-class de.febrildur.sieveeditor.Application \
            --name SieveEditor \
            --app-version ${{ steps.version.outputs.mac_version }} \
            --vendor "SieveEditor Project" \
            --description "ManageSieve script editor" \
            --copyright "Copyright 2025 SieveEditor Contributors" \
            --type dmg \
            --mac-package-name "SieveEditor" \
            --mac-package-identifier "de.febrildur.sieveeditor" \
            --java-options '-Dsun.java2d.uiScale=2.0'

      - name: Find DMG file
        id: package
        run: |
          DMG=$(ls SieveEditor-*.dmg)
          echo "file=$DMG" >> $GITHUB_OUTPUT
          echo "Package created: $DMG"
          ls -lh $DMG

      - name: Upload DMG artifact
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: sieveeditor-dmg
          path: ${{ steps.package.outputs.file }}
          retention-days: 30

      - name: Attest package provenance
        uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a # v3.0.0
        with:
          subject-path: ${{ steps.package.outputs.file }}

  # Linux Flatpak packaging (universal Linux package)
  package-flatpak:
    name: Package Flatpak (Linux Universal)
    runs-on: ubuntu-latest
    needs: build-jar
    container:
      image: ghcr.io/flathub-infra/flatpak-github-actions:freedesktop-24.08
      options: --privileged

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Download JAR
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          name: sieveeditor-jar
          path: target

      - name: Get version
        id: version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            # Called via workflow_call from release.yml
            VERSION="${{ inputs.version }}"
          elif [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="0.0.1"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building Flatpak version: $VERSION"

      - name: Build Flatpak
        uses: flatpak/flatpak-github-actions/flatpak-builder@92ae9851ad316786193b1fd3f40c4b51eb5cb101 # v6.6
        with:
          bundle: SieveEditor-${{ steps.version.outputs.version }}.flatpak
          manifest-path: de.febrildur.sieveeditor.yml
          cache-key: flatpak-builder-${{ hashFiles('de.febrildur.sieveeditor.yml') }}
          arch: x86_64
          branch: master
          upload-artifact: false

      - name: Upload Flatpak artifact
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: sieveeditor-flatpak
          path: SieveEditor-${{ steps.version.outputs.version }}.flatpak
          retention-days: 30

      - name: Attest Flatpak provenance
        uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a # v3.0.0
        with:
          subject-path: SieveEditor-${{ steps.version.outputs.version }}.flatpak

  # Generate checksums and attestations summary
  checksums:
    name: Generate Checksums
    runs-on: ubuntu-latest
    needs: [build-jar, package-linux, package-windows, package-macos, package-flatpak]
    if: github.event_name == 'release' || inputs.tag_name != ''

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - name: Download all artifacts
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          path: artifacts

      - name: Generate SHA256 checksums
        run: |
          cd artifacts
          find . -type f \( -name "*.jar" -o -name "*.deb" -o -name "*.rpm" -o -name "*.msi" -o -name "*.dmg" -o -name "*.flatpak" \) -exec sha256sum {} \; > ../checksums.txt
          cd ..
          echo "=== Checksums ==="
          cat checksums.txt

      - name: Upload checksums
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: checksums
          path: checksums.txt
          retention-days: 90

  # Upload artifacts to GitHub release
  upload-to-release:
    name: Upload Artifacts to Release
    runs-on: ubuntu-latest
    needs: [checksums]
    if: github.event_name == 'release' || inputs.tag_name != ''
    permissions:
      contents: write

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - name: Download all artifacts
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          path: artifacts

      - name: Upload artifacts to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Determine the release tag
          if [ -n "${{ inputs.tag_name }}" ]; then
            RELEASE_TAG="${{ inputs.tag_name }}"
          else
            RELEASE_TAG="${{ github.event.release.tag_name }}"
          fi

          echo "Uploading artifacts to release: $RELEASE_TAG"
          cd artifacts

          # Find all package files
          FILES=$(find . -type f \( -name "*.jar" -o -name "*.deb" -o -name "*.rpm" -o -name "*.msi" -o -name "*.dmg" -o -name "*.flatpak" \))

          # Upload each file to the release
          for file in $FILES; do
            echo "Uploading $file to release $RELEASE_TAG"
            gh release upload "$RELEASE_TAG" "$file" --repo "${{ github.repository }}"
          done

          # Upload checksums
          if [ -f checksums/checksums.txt ]; then
            echo "Uploading checksums.txt to release"
            gh release upload "$RELEASE_TAG" checksums/checksums.txt --repo "${{ github.repository }}"
          fi
