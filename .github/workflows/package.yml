name: Package

on:
  workflow_dispatch:  # Manual trigger for testing
    inputs:
      version:
        description: 'Version to package (e.g., 0.0.1)'
        required: true
        default: '0.0.1'
  release:
    types: [published]  # Trigger when release is published

permissions:
  contents: read
  id-token: write  # For artifact attestations
  attestations: write  # For provenance

jobs:
  # Build JAR once, use for all platforms
  build-jar:
    name: Build JAR
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
        with:
          submodules: recursive

      - name: Set up JDK 21
        uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165 # v5.0.0
        with:
          java-version: 21
          distribution: 'temurin'
          cache: 'maven'

      - name: Build ManageSieveJ
        run: |
          cd lib/ManageSieveJ
          mvn clean install -DskipTests

      - name: Build JAR
        run: |
          cd app
          mvn clean package -DskipTests -B

      - name: Upload JAR for packaging
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: sieveeditor-jar
          path: app/target/SieveEditor-jar-with-dependencies.jar
          retention-days: 1

  # Linux packaging: DEB, RPM
  package-linux:
    name: Package Linux (${{ matrix.package-type }})
    runs-on: ubuntu-latest
    needs: build-jar
    strategy:
      matrix:
        package-type: [deb, rpm]

    steps:
      - name: Checkout code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Set up JDK 21
        uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165 # v5.0.0
        with:
          java-version: 21
          distribution: 'temurin'

      - name: Install packaging tools
        run: |
          if [ "${{ matrix.package-type }}" = "deb" ]; then
            sudo apt-get update
            sudo apt-get install -y fakeroot
          elif [ "${{ matrix.package-type }}" = "rpm" ]; then
            sudo apt-get update
            sudo apt-get install -y rpm
          fi

      - name: Download JAR
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          name: sieveeditor-jar
          path: app/target

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"  # Remove 'v' prefix
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="0.0.1-SNAPSHOT"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Create package
        run: |
          jpackage \
            --input app/target \
            --main-jar SieveEditor-jar-with-dependencies.jar \
            --main-class de.febrildur.sieveeditor.Application \
            --name SieveEditor \
            --app-version ${{ steps.version.outputs.version }} \
            --vendor "SieveEditor Project" \
            --description "ManageSieve script editor for managing email filtering rules" \
            --copyright "Copyright 2025 SieveEditor Contributors" \
            --type ${{ matrix.package-type }} \
            --linux-shortcut \
            --linux-menu-group "Network;Email" \
            --linux-app-category "Network" \
            --java-options '-Dsun.java2d.uiScale=2.0'

      - name: Find package file
        id: package
        run: |
          if [ "${{ matrix.package-type }}" = "deb" ]; then
            PKG=$(ls sieveeditor_*.deb)
          elif [ "${{ matrix.package-type }}" = "rpm" ]; then
            PKG=$(ls sieveeditor-*.rpm)
          fi
          echo "file=$PKG" >> $GITHUB_OUTPUT
          echo "Package created: $PKG"
          ls -lh $PKG

      - name: Upload package artifact
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: sieveeditor-${{ matrix.package-type }}
          path: ${{ steps.package.outputs.file }}
          retention-days: 30

      - name: Attest package provenance
        uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a # v3.0.0
        with:
          subject-path: ${{ steps.package.outputs.file }}

  # Windows packaging: MSI
  package-windows:
    name: Package Windows (MSI)
    runs-on: windows-latest
    needs: build-jar

    steps:
      - name: Checkout code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Set up JDK 21
        uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165 # v5.0.0
        with:
          java-version: 21
          distribution: 'temurin'

      - name: Install WiX Toolset
        run: |
          choco install wixtoolset -y
          echo "C:\Program Files (x86)\WiX Toolset v3.11\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Download JAR
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          name: sieveeditor-jar
          path: app/target

      - name: Get version
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="0.0.1"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Create MSI package
        shell: cmd
        run: |
          jpackage ^
            --input app\target ^
            --main-jar SieveEditor-jar-with-dependencies.jar ^
            --main-class de.febrildur.sieveeditor.Application ^
            --name SieveEditor ^
            --app-version ${{ steps.version.outputs.version }} ^
            --vendor "SieveEditor Project" ^
            --description "ManageSieve script editor" ^
            --copyright "Copyright 2025 SieveEditor Contributors" ^
            --type msi ^
            --win-dir-chooser ^
            --win-menu ^
            --win-shortcut ^
            --win-menu-group "SieveEditor" ^
            --java-options "-Dsun.java2d.uiScale=2.0"

      - name: Find MSI file
        id: package
        shell: bash
        run: |
          MSI=$(ls SieveEditor-*.msi)
          echo "file=$MSI" >> $GITHUB_OUTPUT
          echo "Package created: $MSI"
          ls -lh $MSI

      - name: Upload MSI artifact
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: sieveeditor-msi
          path: ${{ steps.package.outputs.file }}
          retention-days: 30

      - name: Attest package provenance
        uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a # v3.0.0
        with:
          subject-path: ${{ steps.package.outputs.file }}

  # macOS packaging: DMG
  package-macos:
    name: Package macOS (DMG)
    runs-on: macos-latest
    needs: build-jar

    steps:
      - name: Checkout code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Set up JDK 21
        uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165 # v5.0.0
        with:
          java-version: 21
          distribution: 'temurin'

      - name: Download JAR
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          name: sieveeditor-jar
          path: app/target

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="0.0.1"
          fi

          # macOS requires versions starting with 1+ (not 0)
          # Transform 0.x.y to 1.0.x for macOS compatibility
          if [[ "$VERSION" =~ ^0\.([0-9]+)\.([0-9]+)$ ]]; then
            MAC_VERSION="1.0.${BASH_REMATCH[1]}"
            echo "Original version $VERSION starts with 0, using $MAC_VERSION for macOS"
          elif [[ "$VERSION" =~ ^0\.([0-9]+)$ ]]; then
            MAC_VERSION="1.0.${BASH_REMATCH[1]}"
            echo "Original version $VERSION starts with 0, using $MAC_VERSION for macOS"
          else
            MAC_VERSION="$VERSION"
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "mac_version=$MAC_VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION (macOS: $MAC_VERSION)"

      - name: Create DMG package
        run: |
          jpackage \
            --input app/target \
            --main-jar SieveEditor-jar-with-dependencies.jar \
            --main-class de.febrildur.sieveeditor.Application \
            --name SieveEditor \
            --app-version ${{ steps.version.outputs.mac_version }} \
            --vendor "SieveEditor Project" \
            --description "ManageSieve script editor" \
            --copyright "Copyright 2025 SieveEditor Contributors" \
            --type dmg \
            --mac-package-name "SieveEditor" \
            --mac-package-identifier "de.febrildur.sieveeditor" \
            --java-options '-Dsun.java2d.uiScale=2.0'

      - name: Find DMG file
        id: package
        run: |
          DMG=$(ls SieveEditor-*.dmg)
          echo "file=$DMG" >> $GITHUB_OUTPUT
          echo "Package created: $DMG"
          ls -lh $DMG

      - name: Upload DMG artifact
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: sieveeditor-dmg
          path: ${{ steps.package.outputs.file }}
          retention-days: 30

      - name: Attest package provenance
        uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a # v3.0.0
        with:
          subject-path: ${{ steps.package.outputs.file }}

  # Linux Flatpak packaging (universal Linux package)
  package-flatpak:
    name: Package Flatpak (Linux Universal)
    runs-on: ubuntu-latest
    needs: build-jar

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download JAR
        uses: actions/download-artifact@v6
        with:
          name: sieveeditor-jar
          path: app/target

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="0.0.1"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building Flatpak version: $VERSION"

      - name: Build Flatpak
        uses: flatpak/flatpak-github-actions/flatpak-builder@v6
        with:
          bundle: SieveEditor-${{ steps.version.outputs.version }}.flatpak
          manifest-path: de.febrildur.sieveeditor.yml
          cache-key: flatpak-builder-${{ github.sha }}

      - name: Upload Flatpak artifact
        uses: actions/upload-artifact@v4
        with:
          name: sieveeditor-flatpak
          path: SieveEditor-${{ steps.version.outputs.version }}.flatpak
          retention-days: 30

      - name: Attest Flatpak provenance
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: SieveEditor-${{ steps.version.outputs.version }}.flatpak

  # Generate checksums and attestations summary
  checksums:
    name: Generate Checksums
    runs-on: ubuntu-latest
    needs: [build-jar, package-linux, package-windows, package-macos, package-flatpak]
    if: github.event_name == 'release'

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          path: artifacts

      - name: Generate SHA256 checksums
        run: |
          cd artifacts
          find . -type f \( -name "*.jar" -o -name "*.deb" -o -name "*.rpm" -o -name "*.msi" -o -name "*.dmg" -o -name "*.flatpak" \) -exec sha256sum {} \; > ../checksums.txt
          cd ..
          echo "=== Checksums ==="
          cat checksums.txt

      - name: Upload checksums
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: checksums
          path: checksums.txt
          retention-days: 90
