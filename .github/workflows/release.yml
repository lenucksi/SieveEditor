name: Release

on:
  push:
    branches:
      - main

permissions:
  contents: write  # For creating releases and updating CHANGELOG
  pull-requests: write  # For creating release PRs
  id-token: write  # For attestations

jobs:
  release-please:
    name: Release Please
    runs-on: ubuntu-latest

    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
      upload_url: ${{ steps.release.outputs.upload_url }}

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - name: Run Release Please
        id: release
        uses: googleapis/release-please-action@16a9c90856f42705d54a6fda1823352bdc62cf38 # v4.4.0
        with:
          release-type: maven
          package-name: sieveeditor
          # Changelog sections configuration
          changelog-types: |
            [
              {"type":"feat","section":"Features","hidden":false},
              {"type":"fix","section":"Bug Fixes","hidden":false},
              {"type":"perf","section":"Performance Improvements","hidden":false},
              {"type":"security","section":"Security","hidden":false},
              {"type":"deps","section":"Dependencies","hidden":false},
              {"type":"docs","section":"Documentation","hidden":true},
              {"type":"test","section":"Tests","hidden":true},
              {"type":"chore","section":"Miscellaneous","hidden":true}
            ]

  # Build and package for all platforms
  build-release-artifacts:
    name: Build Release Artifacts
    needs: release-please
    if: needs.release-please.outputs.release_created == 'true'
    uses: ./.github/workflows/package.yml
    secrets: inherit
    permissions:
      contents: read
      id-token: write
      attestations: write

  # Upload artifacts to GitHub Release
  upload-release-assets:
    name: Upload Release Assets
    runs-on: ubuntu-latest
    needs: [release-please, build-release-artifacts]
    if: needs.release-please.outputs.release_created == 'true'

    permissions:
      contents: write  # To upload assets to release
      id-token: write  # For attestations

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - name: Download all artifacts
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Generate SHA256 checksums
        run: |
          cd artifacts
          find . -type f \( -name "*.jar" -o -name "*.deb" -o -name "*.rpm" -o -name "*.msi" -o -name "*.dmg" \) -exec sh -c 'sha256sum "$1" | sed "s|./||"' _ {} \; > ../checksums.txt
          cd ..
          echo "=== Checksums ==="
          cat checksums.txt

      - name: Upload JAR to release
        uses: actions/upload-release-asset@e8f9f06c4b078e705bd2ea027f0926603fc9b4d5 # v1.0.2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.release-please.outputs.upload_url }}
          asset_path: artifacts/sieveeditor-jar/SieveEditor-jar-with-dependencies.jar
          asset_name: SieveEditor-${{ needs.release-please.outputs.version }}.jar
          asset_content_type: application/java-archive

      - name: Upload DEB to release
        uses: actions/upload-release-asset@e8f9f06c4b078e705bd2ea027f0926603fc9b4d5 # v1.0.2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.release-please.outputs.upload_url }}
          asset_path: artifacts/sieveeditor-deb/*.deb
          asset_name: SieveEditor-${{ needs.release-please.outputs.version }}.deb
          asset_content_type: application/vnd.debian.binary-package

      - name: Upload RPM to release
        uses: actions/upload-release-asset@e8f9f06c4b078e705bd2ea027f0926603fc9b4d5 # v1.0.2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.release-please.outputs.upload_url }}
          asset_path: artifacts/sieveeditor-rpm/*.rpm
          asset_name: SieveEditor-${{ needs.release-please.outputs.version }}.rpm
          asset_content_type: application/x-rpm

      - name: Upload MSI to release
        uses: actions/upload-release-asset@e8f9f06c4b078e705bd2ea027f0926603fc9b4d5 # v1.0.2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.release-please.outputs.upload_url }}
          asset_path: artifacts/sieveeditor-msi/*.msi
          asset_name: SieveEditor-${{ needs.release-please.outputs.version }}.msi
          asset_content_type: application/x-msi

      - name: Upload DMG to release
        uses: actions/upload-release-asset@e8f9f06c4b078e705bd2ea027f0926603fc9b4d5 # v1.0.2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.release-please.outputs.upload_url }}
          asset_path: artifacts/sieveeditor-dmg/*.dmg
          asset_name: SieveEditor-${{ needs.release-please.outputs.version }}.dmg
          asset_content_type: application/x-apple-diskimage

      - name: Upload checksums to release
        uses: actions/upload-release-asset@e8f9f06c4b078e705bd2ea027f0926603fc9b4d5 # v1.0.2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.release-please.outputs.upload_url }}
          asset_path: checksums.txt
          asset_name: checksums.txt
          asset_content_type: text/plain

      - name: Add installation instructions to release
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const release_id = context.payload.release.id;
            const version = '${{ needs.release-please.outputs.version }}';

            const instructions = `
            ## Installation Instructions

            ### Linux (Ubuntu/Debian)
            \`\`\`bash
            wget https://github.com/${{ github.repository }}/releases/download/v${version}/SieveEditor-${version}.deb
            sudo dpkg -i SieveEditor-${version}.deb
            \`\`\`

            ### Linux (Fedora/RHEL)
            \`\`\`bash
            wget https://github.com/${{ github.repository }}/releases/download/v${version}/SieveEditor-${version}.rpm
            sudo rpm -i SieveEditor-${version}.rpm
            \`\`\`

            ### Windows
            Download \`SieveEditor-${version}.msi\` and run the installer.

            ### macOS
            Download \`SieveEditor-${version}.dmg\`, open it, and drag SieveEditor to Applications.

            ### JAR (All Platforms)
            \`\`\`bash
            wget https://github.com/${{ github.repository }}/releases/download/v${version}/SieveEditor-${version}.jar
            java -jar SieveEditor-${version}.jar
            \`\`\`

            ## Verification

            Download \`checksums.txt\` and verify:
            \`\`\`bash
            sha256sum -c checksums.txt
            \`\`\`

            ## SLSA Provenance

            All artifacts have SLSA Level 3 attestations. Verify with:
            \`\`\`bash
            gh attestation verify SieveEditor-${version}.jar --owner ${{ github.repository_owner }} --repo SieveEditor
            \`\`\`
            `;

            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: release_id,
              body: context.payload.release.body + instructions
            });
