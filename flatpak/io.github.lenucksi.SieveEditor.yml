app-id: io.github.lenucksi.SieveEditor
runtime: org.freedesktop.Platform
runtime-version: '25.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.openjdk21

command: sieveeditor

finish-args:
  # X11 access for Swing GUI
  - --socket=x11
  # IPC namespace (required for X11)
  - --share=ipc
  # Network access for ManageSieve connections
  - --share=network
  # D-Bus access for Secret Service API (GNOME Keyring/KWallet for credential storage, deactivated for now until backend are done)
  # - --talk-name=org.freedesktop.secrets
  # Allow access to XDG data directory for profile storage (apparently auto-provided by Flatpak per App, so comment for now)
  # - --filesystem=xdg-data/sieveeditor:create
  # Allow access to XDG config directory for settings (apparently auto-provided by Flatpak per App, so comment for now)
  # - --filesystem=xdg-config/sieveeditor:create
  # Legacy: Allow access to old profile location for migration
  - --filesystem=~/.sieveprofiles:ro

modules:
  - name: openjdk
    buildsystem: simple
    build-commands:
      - /usr/lib/sdk/openjdk21/install.sh

  - name: sieveeditor
    buildsystem: simple
    build-commands:
      # Create application directory
      - install -d /app/sieveeditor

      # Create bin directory
      - install -d /app/bin

      # Install JAR
      - install -Dm644 SieveEditor-jar-with-dependencies.jar /app/sieveeditor/SieveEditor.jar

      # Create launcher script
      # Note: HiDPI scaling is handled automatically by FlatLaf - no manual scaling needed
      - |
        cat > /app/bin/sieveeditor <<'EOF'
        #!/bin/sh
        # SieveEditor launcher script
        exec /app/jre/bin/java \
          -Dawt.toolkit.name=WLToolkit \
          -Dsun.java2d.vulkan=True \
          -Dawt.useSystemAAFontSettings=lcd \
          -Dswing.aatext=true \
          -jar /app/sieveeditor/SieveEditor.jar "$@"
        EOF

      # Make launcher executable
      - chmod +x /app/bin/sieveeditor

      # Install desktop file
      - install -Dm644 io.github.lenucksi.SieveEditor.desktop /app/share/applications/io.github.lenucksi.SieveEditor.desktop

      # Install icon (if exists)
      - install -Dm644 io.github.lenucksi.SieveEditor.png /app/share/icons/hicolor/256x256/apps/io.github.lenucksi.SieveEditor.png || true

      # Install appdata/metainfo
      - install -Dm644 io.github.lenucksi.SieveEditor.metainfo.xml /app/share/metainfo/io.github.lenucksi.SieveEditor.metainfo.xml

    sources:
      # JAR file from build
      - type: file
        path: target/SieveEditor-jar-with-dependencies.jar

      # Desktop file
      - type: file
        path: flatpak/io.github.lenucksi.SieveEditor.desktop

      # Icon
      - type: file
        path: flatpak/io.github.lenucksi.SieveEditor.png
        dest-filename: io.github.lenucksi.SieveEditor.png

      # AppStream metadata
      - type: file
        path: flatpak/io.github.lenucksi.SieveEditor.metainfo.xml
